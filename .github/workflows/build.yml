name: Build AppImage

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libgtk-3-dev libblkid-dev liblzma-dev libsecret-1-dev libjsoncpp-dev

    - uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.10.0'

    - name: Install dependencies
      run: |
        flutter pub get
        flutter doctor -v

    - name: Build Linux
      run: flutter build linux --release

    - name: Setup AppDir
      run: |
        # Store original files
        mkdir -p temp_appdir
        cp AppDir/AppRun temp_appdir/
        cp AppDir/usr/share/applications/xenia-launcher.desktop temp_appdir/
        cp AppDir/xenia-launcher.svg temp_appdir/
        
        # Remove existing AppDir
        rm -rf AppDir
        
        # Create fresh AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy Flutter build output
        cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
        
        # Restore application files
        cp temp_appdir/AppRun AppDir/
        cp temp_appdir/xenia-launcher.desktop AppDir/usr/share/applications/
        cp temp_appdir/xenia-launcher.svg AppDir/usr/share/icons/hicolor/256x256/apps/
        
        # Create .DirIcon symlink
        ln -s usr/share/icons/hicolor/256x256/apps/xenia-launcher.svg AppDir/.DirIcon
        
        # Cleanup temp directory
        rm -rf temp_appdir
        
        # Ensure AppRun is executable
        chmod +x AppDir/AppRun
        
        # Debug output
        echo "AppDir contents:"
        ls -la AppDir/
        echo "AppDir/usr/bin contents:"
        ls -la AppDir/usr/bin/
        echo "AppDir/usr/share/applications contents:"
        ls -la AppDir/usr/share/applications/

    - name: Download appimagetool
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

    - name: Build AppImage
      run: |
        ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir/
        
    - name: Upload AppImage
      uses: actions/upload-artifact@v3
      with:
        name: Xenia_Launcher-x86_64.AppImage
        path: Xenia_Launcher-x86_64.AppImage

    - name: Get version
      if: startsWith(github.ref, 'refs/tags/')
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Xenia_Launcher-x86_64.AppImage
          README.md
        body: |
          Release ${{ steps.get_version.outputs.VERSION }}
          
          Changes in this release:
          ${{ github.event.head_commit.message }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
